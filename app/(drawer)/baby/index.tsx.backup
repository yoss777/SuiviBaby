import FontAwesome from '@expo/vector-icons/FontAwesome5';
import { useRouter } from 'expo-router';
import React, { useEffect, useState } from 'react';
import { ScrollView, StyleSheet, Text, TouchableOpacity, View, ActivityIndicator } from 'react-native';

import { Colors } from '@/constants/theme';
import { useBaby } from '@/contexts/BabyContext';
import { useColorScheme } from '@/hooks/use-color-scheme';
import { ecouterTetees } from '@/services/teteesService';
import { ecouterPompages } from '@/services/pompagesService';
import { ecouterMictions } from '@/services/mictionsService';

interface TodayStats {
  tetees: { count: number; lastTime?: string };
  pompages: { count: number; quantity: number; lastTime?: string };
  mictions: { count: number; lastTime?: string };
}

export default function BabyDashboard() {
  const { activeBaby } = useBaby();
  const colorScheme = useColorScheme() ?? 'light';
  const router = useRouter();
  const [loading, setLoading] = useState(true);
  const [todayStats, setTodayStats] = useState<TodayStats>({
    tetees: { count: 0 },
    pompages: { count: 0, quantity: 0 },
    mictions: { count: 0 },
  });

  // Calculate baby's age in years and months
  const calculateAge = (birthDate: string) => {
    const [day, month, year] = birthDate.split('/').map(Number);
    const birth = new Date(year, month - 1, day);
    const today = new Date();
    const totalMonths = (today.getFullYear() - birth.getFullYear()) * 12 + (today.getMonth() - birth.getMonth());

    const years = Math.floor(totalMonths / 12);
    const months = totalMonths % 12;

    if (years === 0) {
      return `${totalMonths} mois`;
    } else if (months === 0) {
      return years === 1 ? `${years} an` : `${years} ans`;
    } else {
      const yearText = years === 1 ? 'an' : 'ans';
      return `${years} ${yearText} ${months} mois`;
    }
  };

  // Helper to check if date is today
  const isToday = (timestamp: number) => {
    const date = new Date(timestamp * 1000);
    const today = new Date();
    return (
      date.getDate() === today.getDate() &&
      date.getMonth() === today.getMonth() &&
      date.getFullYear() === today.getFullYear()
    );
  };

  // Helper to format last time
  const formatLastTime = (timestamp: number) => {
    const now = Date.now();
    const diff = Math.floor((now - timestamp * 1000) / 60000); // en minutes

    if (diff < 1) return "√† l'instant";
    if (diff < 60) return `il y a ${diff}min`;

    const hours = Math.floor(diff / 60);
    if (hours < 24) return `il y a ${hours}h`;

    return "plus de 24h";
  };

  // Listen to real-time data
  useEffect(() => {
    if (!activeBaby) return;

    let mounted = true;
    const unsubscribers: (() => void)[] = [];

    const initializeData = async () => {
      try {
        // Listen to t√©t√©es
        const unsubTetees = ecouterTetees((data: any[]) => {
          if (!mounted) return;
          const todayTetees = data.filter(t => isToday(t.date?.seconds || t.createdAt?.seconds));
          const lastTetee = todayTetees[0];

          setTodayStats(prev => ({
            ...prev,
            tetees: {
              count: todayTetees.length,
              lastTime: lastTetee ? formatLastTime(lastTetee.date?.seconds || lastTetee.createdAt?.seconds) : undefined,
            },
          }));
        });
        unsubscribers.push(unsubTetees);

        // Listen to pompages
        const unsubPompages = ecouterPompages((data: any[]) => {
          if (!mounted) return;
          const todayPompages = data.filter(p => isToday(p.date?.seconds || p.createdAt?.seconds));
          const totalQuantity = todayPompages.reduce((sum, p) => sum + (p.quantiteGauche || 0) + (p.quantiteDroite || 0), 0);
          const lastPompage = todayPompages[0];

          setTodayStats(prev => ({
            ...prev,
            pompages: {
              count: todayPompages.length,
              quantity: totalQuantity,
              lastTime: lastPompage ? formatLastTime(lastPompage.date?.seconds || lastPompage.createdAt?.seconds) : undefined,
            },
          }));
        });
        unsubscribers.push(unsubPompages);

        // Listen to mictions
        const unsubMictions = ecouterMictions((data: any[]) => {
          if (!mounted) return;
          const todayMictions = data.filter(m => isToday(m.date?.seconds || m.createdAt?.seconds));
          const lastMiction = todayMictions[0];

          setTodayStats(prev => ({
            ...prev,
            mictions: {
              count: todayMictions.length,
              lastTime: lastMiction ? formatLastTime(lastMiction.date?.seconds || lastMiction.createdAt?.seconds) : undefined,
            },
          }));
        });
        unsubscribers.push(unsubMictions);

        setLoading(false);
      } catch (error) {
        console.error('Error initializing data:', error);
        setLoading(false);
      }
    };

    initializeData();

    return () => {
      mounted = false;
      unsubscribers.forEach(unsub => unsub());
    };
  }, [activeBaby]);

  if (!activeBaby) {
    return (
      <View style={[styles.container, { backgroundColor: Colors[colorScheme].background }]}>
        <Text style={[styles.errorText, { color: Colors[colorScheme].text }]}>
          Aucun b√©b√© s√©lectionn√©
        </Text>
      </View>
    );
  }

  const ageText = calculateAge(activeBaby.birthDate);

  const quickActions = [
    { id: 'tetees', title: 'T√©t√©e', icon: 'heart', color: '#FF6B9D', route: '/(drawer)/baby/tetees' },
    { id: 'pompages', title: 'Pompage', icon: 'pump-medical', color: '#4ECDC4', route: '/(drawer)/baby/pompages' },
    { id: 'vaccins', title: 'Vaccin', icon: 'syringe', color: '#95E1D3', route: '/(drawer)/baby/immunos' },
    { id: 'vitamines', title: 'Vitamine', icon: 'pills', color: '#FFD93D', route: '/(drawer)/baby/immunos' },
    { id: 'pipi', title: 'Pipi', icon: 'tint', color: '#6BCF7F', route: '/(drawer)/baby/excretions' },
    { id: 'popo', title: 'Popo', icon: 'poo', color: '#C9A66B', route: '/(drawer)/baby/excretions' },
  ];

  return (
    <ScrollView style={[styles.container, { backgroundColor: Colors[colorScheme].background }]}>
      {/* Header Card */}
      <View style={[styles.headerCard, { backgroundColor: Colors[colorScheme].tint + '15' }]}>
        <Text style={styles.babyEmoji}>{activeBaby.gender === 'male' ? 'üë∂' : 'üëß'}</Text>
        <Text style={[styles.babyName, { color: Colors[colorScheme].text }]}>
          {activeBaby.name}
        </Text>
        <Text style={[styles.babyInfo, { color: Colors[colorScheme].tabIconDefault }]}>
          {ageText} | {activeBaby.gender === 'male' ? 'N√© le' : 'N√©e le'} {activeBaby.birthDate}
        </Text>
      </View>

      {/* Quick Actions */}
      <View style={styles.section}>
        <Text style={[styles.sectionTitle, { color: Colors[colorScheme].text }]}>
          Actions rapides
        </Text>
        <View style={styles.actionsGrid}>
          {quickActions.map((action) => (
            <TouchableOpacity
              key={action.id}
              style={[styles.actionCard, { backgroundColor: action.color }]}
              onPress={() => router.push(action.route as any)}
              activeOpacity={0.7}
            >
              <FontAwesome name={action.icon} size={24} color="#fff" />
              <Text style={styles.actionText}>{action.title}</Text>
            </TouchableOpacity>
          ))}
        </View>
      </View>

      {/* Today's Summary */}
      <View style={styles.section}>
        <Text style={[styles.sectionTitle, { color: Colors[colorScheme].text }]}>
          R√©sum√© du jour
        </Text>

        {loading ? (
          <View style={styles.loadingContainer}>
            <ActivityIndicator size="large" color={Colors[colorScheme].tint} />
          </View>
        ) : (
          <View style={[styles.summaryCard, { backgroundColor: Colors[colorScheme].background, borderColor: '#e0e0e0' }]}>
            <View style={styles.summaryRow}>
              {/* T√©t√©es */}
              <TouchableOpacity
                style={styles.summaryItem}
                onPress={() => router.push('/(drawer)/baby/tetees')}
                activeOpacity={0.7}
              >
                <FontAwesome name="heart" size={20} color="#FF6B9D" />
                <Text style={[styles.summaryLabel, { color: Colors[colorScheme].tabIconDefault }]}>
                  T√©t√©es
                </Text>
                <Text style={[styles.summaryValue, { color: Colors[colorScheme].text }]}>
                  {todayStats.tetees.count}
                </Text>
                {todayStats.tetees.lastTime && (
                  <Text style={[styles.lastTime, { color: Colors[colorScheme].tabIconDefault }]}>
                    {todayStats.tetees.lastTime}
                  </Text>
                )}
              </TouchableOpacity>

              {/* Pompages */}
              <TouchableOpacity
                style={styles.summaryItem}
                onPress={() => router.push('/(drawer)/baby/pompages')}
                activeOpacity={0.7}
              >
                <FontAwesome name="pump-medical" size={20} color="#4ECDC4" />
                <Text style={[styles.summaryLabel, { color: Colors[colorScheme].tabIconDefault }]}>
                  Pompages
                </Text>
                <Text style={[styles.summaryValue, { color: Colors[colorScheme].text }]}>
                  {todayStats.pompages.count}
                </Text>
                {todayStats.pompages.quantity > 0 && (
                  <Text style={[styles.lastTime, { color: Colors[colorScheme].tabIconDefault }]}>
                    {todayStats.pompages.quantity}ml
                  </Text>
                )}
              </TouchableOpacity>

              {/* Pipis */}
              <TouchableOpacity
                style={styles.summaryItem}
                onPress={() => router.push('/(drawer)/baby/excretions')}
                activeOpacity={0.7}
              >
                <FontAwesome name="tint" size={20} color="#6BCF7F" />
                <Text style={[styles.summaryLabel, { color: Colors[colorScheme].tabIconDefault }]}>
                  Pipis
                </Text>
                <Text style={[styles.summaryValue, { color: Colors[colorScheme].text }]}>
                  {todayStats.mictions.count}
                </Text>
                {todayStats.mictions.lastTime && (
                  <Text style={[styles.lastTime, { color: Colors[colorScheme].tabIconDefault }]}>
                    {todayStats.mictions.lastTime}
                  </Text>
                )}
              </TouchableOpacity>
            </View>
          </View>
        )}
      </View>

      {/* Quick Stats Links */}
      <View style={styles.section}>
        <TouchableOpacity
          style={[styles.statsButton, { backgroundColor: Colors[colorScheme].tint + '10', borderColor: Colors[colorScheme].tint }]}
          onPress={() => router.push('/(drawer)/baby/stats')}
          activeOpacity={0.7}
        >
          <FontAwesome name="chart-line" size={18} color={Colors[colorScheme].tint} />
          <Text style={[styles.statsButtonText, { color: Colors[colorScheme].tint }]}>
            Voir les statistiques d√©taill√©es
          </Text>
          <FontAwesome name="chevron-right" size={16} color={Colors[colorScheme].tint} />
        </TouchableOpacity>
      </View>
    </ScrollView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  errorText: {
    fontSize: 16,
    textAlign: 'center',
    marginTop: 40,
  },
  headerCard: {
    padding: 24,
    margin: 16,
    borderRadius: 16,
    alignItems: 'center',
  },
  babyEmoji: {
    fontSize: 48,
    marginBottom: 12,
  },
  babyName: {
    fontSize: 24,
    fontWeight: '700',
    marginBottom: 8,
  },
  babyInfo: {
    fontSize: 14,
  },
  section: {
    paddingHorizontal: 16,
    marginBottom: 24,
  },
  sectionTitle: {
    fontSize: 18,
    fontWeight: '600',
    marginBottom: 12,
  },
  actionsGrid: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    gap: 12,
  },
  actionCard: {
    width: '31%',
    aspectRatio: 1,
    borderRadius: 12,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 12,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
    elevation: 3,
  },
  actionText: {
    color: '#fff',
    fontSize: 12,
    fontWeight: '600',
    marginTop: 8,
    textAlign: 'center',
  },
  loadingContainer: {
    padding: 40,
    alignItems: 'center',
  },
  summaryCard: {
    borderRadius: 12,
    borderWidth: 1,
    padding: 16,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.05,
    shadowRadius: 4,
    elevation: 2,
  },
  summaryRow: {
    flexDirection: 'row',
    justifyContent: 'space-around',
  },
  summaryItem: {
    alignItems: 'center',
    gap: 8,
    flex: 1,
  },
  summaryLabel: {
    fontSize: 12,
  },
  summaryValue: {
    fontSize: 24,
    fontWeight: '700',
  },
  lastTime: {
    fontSize: 10,
    fontStyle: 'italic',
  },
  statsButton: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    padding: 16,
    borderRadius: 12,
    borderWidth: 1,
    gap: 8,
  },
  statsButtonText: {
    flex: 1,
    fontSize: 14,
    fontWeight: '600',
  },
});
